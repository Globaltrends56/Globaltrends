<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Profile ‚Ä¢ Globaltrends</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

<style>
body{
    margin:0;font-family:-apple-system,sans-serif;background:#fff;
    -webkit-touch-callout:none;-webkit-user-select:none;user-select:none;
    overflow-x:hidden;
}

/* NAV */
.nav{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;border-bottom:1px solid #eee;position:sticky;top:0;background:#fff;z-index:1000}
.nav-right{display:flex;align-items:center;gap:20px}

/* PROFILE HEADER */
.profile-hdr{text-align:center;padding:20px}
.p-avatar-container{width:85px;height:85px;border-radius:50%;background:#e0e0e0;margin:0 auto;overflow:hidden;display:flex;align-items:center;justify-content:center}
.p-avatar-img{width:100%;height:100%;object-fit:cover;display:none}
.p-bio{font-size:13.5px;color:#444;margin-top:8px;display:none}

/* GRID */
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:#eee}
.grid-item{aspect-ratio:9/16;background:#000;position:relative;overflow:hidden;cursor:pointer}
.grid-item img,.grid-item video{width:100%;height:100%;object-fit:cover;pointer-events:none}
.media-indicator{position:absolute;top:5px;right:5px;color:#fff;background:rgba(0,0,0,.4);padding:2px 6px;border-radius:4px;font-size:11px}

/* FULLSCREEN */
#fsPlayer{position:fixed;inset:0;background:#000;z-index:5000;display:none;flex-direction:column}
.fs-close{position:absolute;top:20px;left:20px;color:#fff;font-size:24px;z-index:5100}
.carousel-container{width:100%;height:100%;display:flex;overflow-x:auto;scroll-snap-type:x mandatory}
.carousel-item{min-width:100%;display:flex;align-items:center;justify-content:center}
.carousel-item img,.carousel-item video{
    max-width:100%;max-height:100%;object-fit:contain;
    pointer-events:none;-webkit-touch-callout:none
}
</style>
</head>

<body oncontextmenu="return false;">

<!-- NAV -->
<div class="nav">
    <i class="fa fa-arrow-left" onclick="history.back()"></i>
    <b>Profile</b>
    <div class="nav-right">
        <i class="fa fa-share-alt" onclick="navigator.share({url:location.href})"></i>
        <i class="fa fa-ellipsis-v"></i>
    </div>
</div>

<!-- PROFILE HEADER -->
<div class="profile-hdr">
    <div class="p-avatar-container">
        <i id="defaultIcon" class="fa fa-user" style="font-size:40px"></i>
        <img id="pAv" class="p-avatar-img">
    </div>
    <div id="pUn" style="font-size:18px;font-weight:700;margin-top:10px"></div>
    <div id="pBio" class="p-bio"></div>
</div>

<!-- GRID -->
<div id="grid" class="grid"></div>

<!-- FULLSCREEN -->
<div id="fsPlayer">
    <i class="fa fa-times fs-close" onclick="closeFS()"></i>
    <div id="mediaContent" style="width:100%;height:100%"></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
 "https://spnvgymmrlyqtfrbjjsg.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwbnZneW1tcmx5cXRmcmJqanNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzM4ODMsImV4cCI6MjA4MzUwOTg4M30.EAgw94HZsHa21YLcTuV0GLAlUeRZN-ixKA0QeD5oPNI"
);

const myId = localStorage.getItem("user_id");
const profileId = new URLSearchParams(location.search).get("id") || myId;

const postsMap = {};
let currentPost = null;

/* LOAD PROFILE */
async function loadProfile(){
 const { data } = await supabase.from("profiles").select("*").eq("id",profileId).single();
 if(!data) return;

 document.getElementById("pUn").innerHTML =
   `@${data.username} ${data.verified ? '<i class="fa fa-check-circle" style="color:#1DA1F2"></i>' : ''}`;

 if(data.bio){
   const bio=document.getElementById("pBio");
   bio.innerText=data.bio;
   bio.style.display="block";
 }

 if(data.avatar_url){
   document.getElementById("pAv").src=data.avatar_url;
   document.getElementById("pAv").style.display="block";
   document.getElementById("defaultIcon").style.display="none";
 }
}

/* LOAD POSTS */
async function loadPosts(){
 const { data } = await supabase
   .from("posts")
   .select("*")
   .eq("user_id",profileId)
   .order("created_at",{ascending:false});

 const grid=document.getElementById("grid");
 grid.innerHTML="";

 data.forEach(p=>{
   postsMap[p.id]=p;

   const div=document.createElement("div");
   div.className="grid-item";
   div.onclick=()=>openFS(p.id);

   div.innerHTML=`
     <div class="media-indicator">${p.media_type==="photo"?"üñºÔ∏è":"üéûÔ∏è"}</div>
     ${p.media_type==="photo"
       ? `<img src="${p.media_urls[0]}">`
       : `<video src="${p.video_url}#t=0.2" muted playsinline></video>`}`;

   grid.appendChild(div);
 });
}

/* FULLSCREEN OPEN */
window.openFS = (id)=>{
 currentPost = postsMap[id];
 if(!currentPost) return;

 const fs=document.getElementById("fsPlayer");
 const content=document.getElementById("mediaContent");
 fs.style.display="flex";
 content.innerHTML="";

 if(currentPost.media_type==="photo"){
   const urls=currentPost.media_urls.slice(0,10);
   content.innerHTML=`
     <div class="carousel-container">
       ${urls.map(u=>`<div class="carousel-item"><img src="${u}"></div>`).join("")}
     </div>`;
 }else{
   content.innerHTML=`
     <div class="carousel-item">
       <video src="${currentPost.video_url}"
         autoplay
         loop
         playsinline
         muted
         controlsList="nodownload"
         disablePictureInPicture
         oncontextmenu="return false">
       </video>
     </div>`;
 }
};

/* FULLSCREEN CLOSE ‚Äî AUDIO STOP FIX */
window.closeFS = ()=>{
 const content=document.getElementById("mediaContent");
 const vid=content.querySelector("video");
 if(vid){
   vid.pause();
   vid.src="";
   vid.load();
 }
 content.innerHTML="";
 document.getElementById("fsPlayer").style.display="none";
};

loadProfile();
loadPosts();
</script>
</body>
</html>
