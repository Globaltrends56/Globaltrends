<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Upload Photo â€¢ Globaltrends</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
    <style>
        body { margin:0; font-family:-apple-system, sans-serif; background:#fff; -webkit-touch-callout:none; user-select:none; }
        .nav { display:flex; align-items:center; padding:12px 18px; border-bottom:1px solid #eee; gap:20px; }
        .upload-container { padding: 20px; text-align: center; }
        .preview-box { width: 100%; aspect-ratio: 1/1; background: #eee; border-radius: 12px; margin-bottom: 20px; overflow: hidden; display: none; }
        img { width: 100%; height: 100%; object-fit: cover; -webkit-touch-callout: none; }
        textarea { width: 100%; border: 1px solid #eee; border-radius: 8px; padding: 12px; box-sizing: border-box; margin-bottom: 20px; resize: none; font-size: 16px; }
        .btn-post { width: 100%; padding: 15px; background: #000; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        /* TOAST SYSTEM */
        #toast { 
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%); 
            background: #ff2d55; color: #fff; padding: 15px 25px; border-radius: 30px; 
            font-weight: bold; z-index: 20000; transition: top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center; width: 80%;
        }
        #toast.show { top: 30px; }

        #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.98); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; text-align: center; }
        .spinner { font-size: 40px; color: #ff2d55; margin-bottom: 15px; animation: fa-spin 1s infinite linear; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="toast">Violation Detected! Account Suspended.</div>

<div id="loadingOverlay">
    <i class="fa fa-shield-alt spinner"></i>
    <b id="statusText">AI Security Scanning...</b>
    <p style="color: #666; font-size: 14px; margin-top: 10px;">Scanning photo for policy violations.</p>
</div>

<div class="nav">
    <i class="fa fa-times" onclick="history.back()"></i>
    <b>New Photo Post</b>
</div>

<div class="upload-container">
    <div id="previewBox" class="preview-box">
        <img id="previewImg" oncontextmenu="return false;">
    </div>
    <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handleFile(this)">
    <button onclick="document.getElementById('photoInput').click()" id="selectBtn" style="margin-bottom: 20px; padding: 12px 25px; border-radius: 25px; border: 2px solid #000; background: none; font-weight: bold;">Select Photo</button>
    <textarea id="caption" placeholder="Add a caption..." rows="4"></textarea>
    <button id="uploadBtn" class="btn-post" onclick="startUpload()" disabled>Post Photo</button>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient("https://spnvgymmrlyqtfrbjjsg.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwbnZneW1tcmx5cXRmcmJqanNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzM4ODMsImV4cCI6MjA4MzUwOTg4M30.EAgw94HZsHa21YLcTuV0GLAlUeRZN-ixKA0QeD5oPNI");

const GEMINI_KEY = "YOUR_GEMINI_API_KEY_HERE"; 
let selectedFile = null;
const myId = localStorage.getItem("user_id");

function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg;
    t.classList.add('show');
}

window.handleFile = (input) => {
    selectedFile = input.files[0];
    if (selectedFile) {
        document.getElementById('previewImg').src = URL.createObjectURL(selectedFile);
        document.getElementById('previewBox').style.display = 'block';
        document.getElementById('uploadBtn').disabled = false;
    }
};

async function checkAISecurity(file) {
    try {
        const base64 = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(file);
        });

        const resp = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{ parts: [
                    { text: "Safety Check: If this image contains nudity, porn, or gore, respond ONLY with 'BANNED'. Else respond 'SAFE'." },
                    { inline_data: { mime_type: file.type, data: base64 } }
                ]}]
            })
        });

        const data = await resp.json();
        if (data.error) return "ERROR";

        const verdict = data.candidates[0].content.parts[0].text.trim().toUpperCase();
        return verdict.includes("BANNED") ? "BANNED" : "SAFE";
    } catch (e) { return "ERROR"; }
}

window.startUpload = async () => {
    if (!selectedFile || !myId) return;

    const overlay = document.getElementById('loadingOverlay');
    const statusText = document.getElementById('statusText');
    overlay.style.display = 'flex';

    const verdict = await checkAISecurity(selectedFile);

    if (verdict === "BANNED") {
        showToast("AI Alert: Violation Detected!");
        statusText.innerText = "ACCOUNT SUSPENDED";

        // Update DB in background
        supabase.from('profiles').update({ status: 'suspended' }).eq('id', myId).then();

        // Redirect
        setTimeout(() => {
            window.location.replace('suspended.html');
        }, 2000);
        return;
    }

    if (verdict === "ERROR") {
        overlay.style.display = 'none';
        alert("Failed. Try a smaller photo.");
        return;
    }

    statusText.innerText = "Uploading...";
    const fileName = `${Date.now()}_photo.jpg`;
    
    await supabase.storage.from('photos').upload(fileName, selectedFile);
    const { data: urlData } = supabase.storage.from('photos').getPublicUrl(fileName);

    await supabase.from('posts').insert([{
        user_id: myId,
        media_urls: [urlData.publicUrl],
        caption: document.getElementById('caption').value,
        media_type: 'photo'
    }]);

    window.location.href = 'profile.html';
};
</script>
</body>
</html>
