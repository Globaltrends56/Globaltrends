<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Post photo â€¢ Globaltrends</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
<style>
:root { --primary:#ff2d55; --bg:#fff; --border:#efefef; }
body { margin:0; font-family:-apple-system,sans-serif; background:var(--bg); }
.header { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border); position:sticky; top:0; background:#fff; z-index:100; }
.header b { font-size:17px; }
.header span { color:#666; cursor:pointer; }
.post-btn-text { color:var(--primary); font-weight:700; cursor:pointer; }
.container { padding:20px; }
.upload-box { border:2px dashed #ddd; border-radius:12px; padding:40px 20px; text-align:center; background:#fafafa; cursor:pointer; }
.upload-box i { font-size:30px; color:var(--primary); margin-bottom:10px; }
.preview-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:20px; }
.preview-grid img { width:100%; aspect-ratio:1; object-fit:cover; border-radius:8px; border:1px solid #eee; }
.caption { width:100%; border:1px solid var(--border); border-radius:12px; padding:15px; margin-top:20px; font-size:15px; outline:none; resize:none; background:#fafafa; }
.post-btn { width:100%; margin-top:25px; padding:16px; border:none; border-radius:12px; background:var(--primary); color:#fff; font-weight:700; font-size:16px; }
.toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#111; color:#fff; padding:12px 24px; border-radius:30px; display:none; z-index:10000; }
#addBtn { background: #e0e0e0; color: #333;}
</style>
</head>
<body>

<div id="toast" class="toast"></div>

<div class="header">
  <span onclick="history.back()">Cancel</span>
  <b>New Photo Post</b>
  <span class="post-btn-text" onclick="upload()">Post</span>
</div>

<div class="container">
  <label class="upload-box">
    <input type="file" id="photos" accept="image/*" hidden>
    <i class="fa fa-images"></i>
    <div style="font-weight:600">Select Photos</div>
    <div style="font-size:12px;color:#888">Add photos one by one (max 10)</div>
  </label>

  <input type="file" id="morePhotos" accept="image/*" hidden>
  <div class="preview-grid" id="previewGrid"></div>
  <button id="addBtn" class="post-btn" style="display:none" onclick="morePhotos.click()">Add Photos</button>
  <textarea id="caption" class="caption" rows="4" placeholder="Write a caption..."></textarea>
  <button id="mainBtn" class="post-btn" onclick="upload()">Share Post</button>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://spnvgymmrlyqtfrbjjsg.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwbnZneW1tcmx5cXRmcmJqanNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzM4ODMsImV4cCI6MjA4MzUwOTg4M30.EAgw94HZsHa21YLcTuV0GLAlUeRZN-ixKA0QeD5oPNI"
);

const myId = localStorage.getItem("user_id");

// --- CODY AI CONFIGURATION ---
const CODY_API_KEY = "tm-Vzbm0YG8p8nVLiSfIIwh2yfynYPsJXTH753Lqzrme97e6bf8"; // Paste your Cody API Key here

const input = document.getElementById("photos");
const moreInput = document.getElementById("morePhotos");
const grid = document.getElementById("previewGrid");
const addBtn = document.getElementById("addBtn");
const files = [];

function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.style.display="block";
  setTimeout(()=>t.style.display="none",3000);
}

function addFile(file){
  if(files.length>=10){ showToast("Maximum of 10 photos allowed"); return; }
  files.push(file);
  const wrap=document.createElement("div");
  wrap.style.position="relative";
  const img=document.createElement("img");
  img.src=URL.createObjectURL(file);
  wrap.appendChild(img);
  const x=document.createElement("span");
  x.innerHTML="&times;";
  Object.assign(x.style,{
    position:"absolute",top:"4px",right:"4px",
    background:"#111",color:"#fff",borderRadius:"50%",
    width:"20px",height:"20px",display:"flex",
    alignItems:"center",justifyContent:"center",
    fontSize:"14px",cursor:"pointer"
  });
  x.onclick=()=>{
    files.splice(files.indexOf(file),1);
    grid.removeChild(wrap);
    if(!files.length) addBtn.style.display="none";
  };
  wrap.appendChild(x);
  grid.appendChild(wrap);
  addBtn.style.display="block";
}

input.onchange=e=>{
  const f=e.target.files[0];
  if(!f) return;
  grid.innerHTML="";
  files.length=0;
  addFile(f);
};

moreInput.onchange=e=>{
  const f=e.target.files[0];
  if(!f) return;
  addFile(f);
};

/* UPLOAD + CODY AI SECURITY CHECK */
window.upload=async()=>{
  if(!files.length) return showToast("Select photo");
  if(!myId) return showToast("User not logged in");

  const caption=document.getElementById("caption").value;
  const btn=document.getElementById("mainBtn");
  btn.disabled=true;
  btn.textContent="Security Scanning...";

  try {
    // 1. CODY AI SECURITY SCAN (TEXT/CONTENT BASED)
    const codyRes = await fetch("https://getcody.ai/api/v1/messages", {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${CODY_API_KEY}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            content: `MODERATOR TASK: Analyze this post for violations (nudity, sexual content, hate speech, or gore). 
            Caption: "${caption}". 
            If it violates policies, reply ONLY with 'BLOCK'. 
            If it is safe, reply ONLY with 'PASS'.`
        })
    });

    const codyData = await codyRes.json();
    const verdict = (codyData.data?.content || "").toUpperCase();

    if (verdict.includes("BLOCK")) {
        showToast("Content Violated Policy. Suspending...");
        await supabase.from("profiles").update({status:"suspended"}).eq("id", myId);
        setTimeout(() => location.href = "suspended.html", 2000);
        return;
    }

    // 2. PROCEED TO IMAGE UPLOAD
    btn.textContent = "Uploading Photos...";
    const urls = [];

    for(const file of files) {
      const path=`${myId}/${Date.now()}-${Math.random()}.jpg`;
      const { data: storageData, error: storageError } = await supabase.storage.from("photos").upload(path, file);
      
      if(storageError) throw storageError;
      
      urls.push(supabase.storage.from("photos").getPublicUrl(path).data.publicUrl);
    }

    // 3. INSERT INTO DATABASE
    await supabase.from("posts").insert({
      user_id: myId,
      media_type: "photo",
      media_urls: urls,
      caption,
      likes: 0
    });

    location.href = "profile.html";

  } catch (e) {
    console.error(e);
    showToast("Upload failed. Try again.");
    btn.disabled = false;
    btn.textContent = "Share Post";
  }
};
</script>
</body>
    </html>
