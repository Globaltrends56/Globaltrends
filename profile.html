<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Profile ‚Ä¢ Globaltrends</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
    <style>
        :root { --accent: #ff2d55; --bg: #ffffff; --blue: #1da1f2; }
        body { margin:0; font-family:-apple-system, sans-serif; background: var(--bg); user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* Navigation */
        .nav { display:flex; justify-content:space-between; align-items:center; padding:12px 18px; border-bottom:1px solid #eee; position:sticky; top:0; background:#fff; z-index: 1000; }
        .nav-right { display: flex; align-items: center; gap: 20px; position: relative; }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: var(--accent); color: #fff; font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: none; align-items: center; justify-content: center; border: 2px solid #fff; font-weight: bold; }
        .verify-badge { color: var(--blue); margin-left: 4px; font-size: 14px; }

        /* Logout Toast */
        #logoutToast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; border-radius: 16px; box-shadow: 0 10px 50px rgba(0,0,0,0.3); padding: 25px; z-index: 9999; display: none; text-align: center; width: 80%; max-width: 300px; }
        .t-btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; margin-top:15px; }
        .btn-yes { background: var(--accent); color: #fff; margin-left: 8px; }

        /* Profile Header */
        .profile-hdr { text-align:center; padding:20px; }
        .p-avatar-box { width: 85px; height: 85px; background: #eee; border-radius: 50%; margin: 0 auto; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        
        /* Dashboard */
        .goal-box { margin: 15px 20px; padding: 12px; background: #f9f9f9; border-radius: 10px; border: 1px solid #eee; display: none; }
        .p-bar { height: 7px; background: #e0e0e0; border-radius: 10px; margin-top: 8px; overflow: hidden; }
        .p-fill { height: 100%; background: var(--accent); width: 0%; transition: 0.8s; }

        /* Grid Indicators */
        .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background:#eee; }
        .grid-item { aspect-ratio: 1/1; background:#000; position: relative; overflow: hidden; }
        .media-type { position: absolute; top: 8px; right: 8px; color: #fff; font-size: 12px; z-index: 5; text-shadow: 0 0 4px rgba(0,0,0,0.8); }

        /* Fullscreen & Carousel */
        #fsPlayer { position: fixed; inset: 0; background: #000; z-index: 9000; display: none; flex-direction: column; }
        .fs-header { position: absolute; top: 0; width: 100%; padding: 45px 15px 15px; display: flex; align-items: center; justify-content: space-between; color: #fff; z-index: 9100; background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent); }
        .fs-user-info { display: flex; align-items: center; gap: 10px; }
        .fs-av { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
        .fs-caption { position: absolute; bottom: 85px; left: 15px; color: #fff; font-size: 14px; width: 75%; text-shadow: 1px 1px 2px #000; z-index: 9100; }
        
        /* Slide Indicators */
        .indicators { position: absolute; bottom: 25px; width: 100%; display: flex; justify-content: center; gap: 5px; z-index: 9105; }
        .dot { width: 6px; height: 6px; background: rgba(255,255,255,0.4); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: #fff; transform: scale(1.2); }

        .fs-actions { position: absolute; right: 15px; bottom: 105px; color: #fff; text-align: center; z-index: 9100; }
        .liked { color: var(--accent) !important; }
    </style>
</head>
<body>

<div id="logoutToast">
    <p style="font-weight:bold;">Are you sure you want to logout?</p>
    <button class="t-btn" onclick="hideLogoutToast()">No</button>
    <button class="t-btn btn-yes" onclick="confirmLogout()">Yes</button>
</div>

<div id="fsPlayer">
    <div class="fs-header">
        <div class="fs-user-info">
            <i class="fa fa-chevron-left" onclick="closeFS()"></i>
            <img id="fsUserAv" class="fs-av">
            <span id="fsUserName" style="font-weight:bold;"></span>
            <i id="fsVerify" class="fa fa-check-circle verify-badge" style="display:none;"></i>
        </div>
        <i id="fsDelete" class="fa fa-ellipsis-v" onclick="deletePost()" style="display:none; padding:10px;"></i>
    </div>
    
    <div id="mediaContainer" style="width:100%; height:100%; display:flex; overflow-x: scroll; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;"></div>
    
    <div id="dots" class="indicators"></div>
    <div id="fsCap" class="fs-caption"></div>
    
    <div class="fs-actions">
        <i id="likeHeart" class="fa fa-heart" style="font-size:32px;" onclick="toggleLike()"></i>
        <div id="fsLikeCount" style="font-weight:bold; font-size:12px; margin-top:5px;">0</div>
    </div>
</div>

<div class="nav">
    <i class="fa fa-arrow-left" onclick="history.back()"></i>
    <b>Profile</b>
    <div class="nav-right" id="navIcons"></div>
</div>

<div class="profile-hdr">
    <div class="p-avatar-box">
        <i id="defIcon" class="fa fa-user" style="font-size:40px;"></i>
        <img id="pAv" style="width:100%;height:100%;object-fit:cover;display:none;">
    </div>
    <div style="font-size:18px; font-weight:bold; margin-top:10px; display:flex; align-items:center; justify-content:center;">
        <span id="pUn"></span><i id="pVerify" class="fa fa-check-circle verify-badge" style="display:none;"></i>
    </div>
    
    <div id="goalDash" class="goal-box">
        <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:bold;">
            <span>CREATOR GOAL: 10K SUBS</span>
            <span id="gPct">0%</span>
        </div>
        <div class="p-bar"><div id="gFill" class="p-fill"></div></div>
    </div>

    <div style="display:flex; justify-content:center; gap:30px; margin:15px 0;">
        <div style="text-align:center;"><span id="sCount" style="font-weight:bold; font-size:18px; display:block;">0</span><small>Subscribers</small></div>
        <div style="text-align:center;"><span id="lCount" style="font-weight:bold; font-size:18px; display:block;">0</span><small>Total Likes</small></div>
    </div>
    <div id="btnArea"></div>
</div>

<div id="grid" class="grid"></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient("https://spnvgymmrlyqtfrbjjsg.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwbnZneW1tcmx5cXRmcmJqanNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzM4ODMsImV4cCI6MjA4MzUwOTg4M30.EAgw94HZsHa21YLcTuV0GLAlUeRZN-ixKA0QeD5oPNI");

const myId = localStorage.getItem("user_id");
const profId = new URLSearchParams(location.search).get("id") || myId;
let curPost = null, profileUser = null;

window.showLogoutToast = () => document.getElementById('logoutToast').style.display = 'block';
window.hideLogoutToast = () => document.getElementById('logoutToast').style.display = 'none';
window.confirmLogout = () => { localStorage.clear(); location.href = "https://globaltrends56.blogspot.com"; };

async function load() {
    const { data: user } = await supabase.from("profiles").select("*").eq("id", profId).single();
    if (!user) return;
    profileUser = user;

    if (user.avatar_url) { document.getElementById('pAv').src = user.avatar_url; document.getElementById('pAv').style.display='block'; document.getElementById('defIcon').style.display='none'; }
    document.getElementById('pUn').innerText = `@${user.username}`;
    if (user.is_verified) document.getElementById('pVerify').style.display = 'inline';

    const { count: subs } = await supabase.from("follows").select("*", {count:"exact", head:true}).eq("user_id", profId);
    document.getElementById('sCount').innerText = subs || 0;
    
    const { data: posts } = await supabase.from("posts").select("*").eq("user_id", profId).order('created_at', {ascending:false});
    document.getElementById('lCount').innerText = posts?.reduce((a, b) => a + (parseInt(b.likes)||0), 0) || 0;

    const nav = document.getElementById('navIcons');
    const area = document.getElementById('btnArea');
    
    if (myId === profId) {
        document.getElementById('goalDash').style.display = 'block';
        const pct = Math.min((subs / 10000) * 100, 100).toFixed(1);
        document.getElementById('gFill').style.width = pct + "%";
        document.getElementById('gPct').innerText = pct + "%";
        nav.innerHTML = `
            <i class="fa fa-share-alt" onclick="navigator.share({url:location.href})"></i>
            <div class="notif-wrapper" onclick="location.href='notifications.html'">
                <i class="fa fa-bell"></i><span id="notifDot" class="notif-badge"></span>
            </div>
            <i class="fa fa-ellipsis-v" onclick="showLogoutToast()"></i>`;
        area.innerHTML = `<button onclick="location.href='edit-profile.html'" style="padding:10px 40px; border-radius:8px; border:none; background:#eee; font-weight:bold; width:80%;">Edit Profile</button>`;
        checkNotifs();
    } else if (!myId) {
        area.innerHTML = `<button onclick="location.href='login.html'" style="padding:10px 40px; border-radius:8px; border:none; background:var(--accent); color:#fff; font-weight:bold; width:80%;">Log In</button>`;
    }

    document.getElementById('grid').innerHTML = posts?.map(i => `
        <div class="grid-item" onclick='openFS(${JSON.stringify(i)})'>
            <div class="media-type">${i.media_type==='photo'?'üñºÔ∏è':'üéûÔ∏è'}</div>
            ${i.media_type==='photo' ? `<img src="${i.media_urls[0]}" style="width:100%;height:100%;object-fit:cover;">` : `<video src="${i.video_url}#t=0.1" style="width:100%;height:100%;object-fit:cover;"></video>`}
        </div>`).join("") || "";
}

window.openFS = (post) => {
    curPost = post;
    document.getElementById('fsPlayer').style.display = 'flex';
    document.getElementById('fsUserName').innerText = `@${profileUser.username}`;
    document.getElementById('fsUserAv').src = profileUser.avatar_url || '';
    document.getElementById('fsVerify').style.display = profileUser.is_verified ? 'inline' : 'none';
    document.getElementById('fsCap').innerText = post.caption || "";
    document.getElementById('fsDelete').style.display = (myId === post.user_id) ? 'block' : 'none';

    const container = document.getElementById('mediaContainer');
    const dotBox = document.getElementById('dots');
    container.innerHTML = ""; dotBox.innerHTML = "";

    if (post.media_type === 'photo') {
        const limitedUrls = post.media_urls.slice(0, 10);
        limitedUrls.forEach((url, index) => {
            container.innerHTML += `<img src="${url}" style="width:100%; flex-shrink:0; scroll-snap-align: center; object-fit: contain;">`;
            if(limitedUrls.length > 1) dotBox.innerHTML += `<div class="dot ${index===0?'active':''}"></div>`;
        });
        container.onscroll = () => {
            const idx = Math.round(container.scrollLeft / container.clientWidth);
            document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === idx));
        };
    } else {
        container.innerHTML = `<video id="vPlayer" src="${post.video_url}" style="width:100%;" autoplay loop playsinline></video>`;
    }
    updateLikeUI();
};

window.deletePost = async () => {
    if (confirm("Permanently delete this post?")) {
        await supabase.from('posts').delete().eq('id', curPost.id);
        closeFS(); load();
    }
};

window.closeFS = () => {
    const v = document.getElementById('vPlayer');
    if (v) { v.pause(); v.src = ""; v.load(); }
    document.getElementById('fsPlayer').style.display = 'none';
};

function updateLikeUI() {
    const isLiked = localStorage.getItem('liked_' + curPost.id);
    document.getElementById('likeHeart').className = isLiked ? 'fa fa-heart liked' : 'fa fa-heart';
    document.getElementById('fsLikeCount').innerText = curPost.likes || 0;
}

window.toggleLike = async () => {
    const key = 'liked_' + curPost.id;
    let count = parseInt(curPost.likes) || 0;
    if (!localStorage.getItem(key)) {
        localStorage.setItem(key, 'true'); count++;
        if (myId !== profId) await supabase.from('notifications').insert({ user_id: profId, sender_id: myId || "anon", type: 'like', post_id: curPost.id });
    } else {
        localStorage.removeItem(key); count = Math.max(0, count - 1);
    }
    curPost.likes = count; updateLikeUI();
    await supabase.from("posts").update({ likes: count }).eq('id', curPost.id);
};

async function checkNotifs() {
    const { count } = await supabase.from('notifications').select('*', {count:'exact', head:true}).eq('user_id', myId).eq('is_read', false);
    if (count > 0) { const d = document.getElementById('notifDot'); d.style.display='flex'; d.innerText=count; }
}
load();
</script>
</body>
    </html>
