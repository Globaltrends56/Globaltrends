<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Post photo â€¢ Globaltrends</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
<style>
    :root { --primary: #ff2d55; --bg: #fff; --border: #efefef; }
    body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: #fff; z-index: 100; }
    .header b { font-size: 17px; }
    .header span { color: #666; cursor: pointer; }
    .post-btn-text { color: var(--primary); font-weight: 700; cursor: pointer; }
    .container { padding: 20px; }
    .upload-box { border: 2px dashed #ddd; border-radius: 12px; padding: 40px 20px; text-align: center; background: #fafafa; cursor: pointer; }
    .upload-box i { font-size: 30px; color: var(--primary); margin-bottom: 10px; }
    .preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 20px; }
    .preview-grid img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; border: 1px solid #eee; }
    .caption { width: 100%; border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-top: 20px; font-size: 15px; outline: none; resize: none; background: #fafafa; }
    .post-btn { width: 100%; margin-top: 25px; padding: 16px; border: none; border-radius: 12px; background: #000; color: #fff; font-weight: 700; font-size: 16px; }
    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #111; color: #fff; padding: 12px 24px; border-radius: 30px; display: none; z-index: 1000; }
</style>
</head>
<body>

<div id="toast" class="toast"></div>

<div class="header">
    <span onclick="history.back()">Cancel</span>
    <b>New Photo Post</b>
    <span class="post-btn-text" onclick="upload()">Post</span>
</div>

<div class="container">
    <label class="upload-box">
        <input type="file" id="photos" accept="image/*" hidden>
        <i class="fa fa-images"></i>
        <div style="font-weight:600">Select Photos</div>
        <div style="font-size:12px; color:#888">1 photo per post for scan</div>
    </label>
    <div class="preview-grid" id="previewGrid"></div>
    <textarea id="caption" class="caption" rows="4" placeholder="Write a caption..."></textarea>
    <button id="mainBtn" class="post-btn" onclick="upload()">Share Post</button>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient("https://spnvgymmrlyqtfrbjjsg.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwbnZneW1tcmx5cXRmcmJqanNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzM4ODMsImV4cCI6MjA4MzUwOTg4M30.EAgw94HZsHa21YLcTuV0GLAlUeRZN-ixKA0QeD5oPNI");

const myId = localStorage.getItem("user_id");
const GEMINI_KEY = "AIzaSyDdlC8_lta2_8hE3O8Q1VvNSmjBDfycbdY";

async function verify() {
    if (!myId) return;
    const { data } = await supabase.from('profiles').select('status').eq('id', myId).single();
    if (data?.status === 'suspended') window.location.href = 'suspended.html';
}
verify();

const input = document.getElementById("photos");
const grid = document.getElementById("previewGrid");

input.onchange = (e) => {
    const file = e.target.files[0];
    if(!file) return;
    grid.innerHTML = "";
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    grid.appendChild(img);
};

window.upload = async () => {
    const file = input.files[0];
    const captionText = document.getElementById("caption").value;
    const btn = document.getElementById("mainBtn");
    if(!file) return alert("Select photo");

    btn.disabled = true; btn.innerText = "AI Scanning...";

    try {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        const base64 = await new Promise(res => reader.onload = () => res(reader.result.split(',')[1]));

        const aiCheck = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
            method: 'POST',
            body: JSON.stringify({ contents: [{ parts: [
                { text: `Safety Check: Block nudity/drugs in this image/caption: "${captionText}". Reply ONLY 'BLOCK' or 'PASS'.` },
                { inline_data: { mime_type: "image/jpeg", data: base64 } }
            ]}]})
        });
        const aiData = await aiCheck.json();
        if (aiData.candidates[0].content.parts[0].text.includes("BLOCK")) {
            await supabase.from('profiles').update({ status: 'suspended' }).eq('id', myId);
            window.location.href = 'suspended.html'; return;
        }
    } catch (e) { console.log("AI error"); }

    btn.innerText = "Posting...";
    const path = `${myId}/${Date.now()}.jpg`;
    await supabase.storage.from("photos").upload(path, file);
    const url = supabase.storage.from("photos").getPublicUrl(path).data.publicUrl;
    await supabase.from("posts").insert({ user_id: myId, media_type: "photo", media_urls: [url], caption: captionText, likes: 0 });
    location.href = "profile.html";
};
</script>
</body>
</html>
