<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Notifications</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
<style>
    body { margin:0; font-family:-apple-system, sans-serif; background:#fff; }
    .nav { display:flex; justify-content:space-between; align-items:center; padding:15px 20px; border-bottom:1px solid #eee; position:sticky; top:0; background:#fff; z-index:100; }
    .item { display:flex; align-items:center; padding:16px 20px; gap:14px; border-bottom:1px solid #f8f8f8; cursor:pointer; }
    .item.unread { background: #fff1f3; }
    .av { width:48px; height:48px; border-radius:50%; background:#eee; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .av i { font-size: 20px; color: #000; }
    .txt { flex:1; font-size:14px; line-height:1.4; }
    .time { font-size:11px; color:#aaa; margin-top:4px; }
    .icon-box { color: #ff2d55; font-size: 14px; }
</style>
</head>
<body>
<div class="nav">
    <div style="display:flex; align-items:center; gap:15px;"><i class="fa fa-arrow-left" onclick="history.back()"></i><b>Activity</b></div>
    <div onclick="clearAll()" style="font-size:13px; color:#ff2d55; font-weight:700;">Clear</div>
</div>
<div id="list"></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient("https://spnvgymmrlyqtfrbjjsg.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwbnZneW1tcmx5cXRmcmJqanNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzM4ODMsImV4cCI6MjA4MzUwOTg4M30.EAgw94HZsHa21YLcTuV0GLAlUeRZN-ixKA0QeD5oPNI");
const myId = localStorage.getItem("user_id");

async function load() {
    if (!myId) return;
    const { data: n } = await supabase.from('notifications').select('*').eq('user_id', myId).order('created_at', {ascending:false});
    const cont = document.getElementById('list');
    if (!n?.length) { cont.innerHTML = '<div style="text-align:center; padding:100px; color:#ccc;">No activity yet</div>'; return; }
    
    await supabase.from('notifications').update({is_read:true}).eq('user_id', myId);
    let h = '';
    for (const item of n) {
        const { data: u } = await supabase.from('profiles').select('username, avatar_url').eq('id', item.sender_id).single();
        h += `
        <div class="item ${item.is_read?'':'unread'}" onclick="location.href='profile.html?id=${item.sender_id}'">
            <div class="av">${u?.avatar_url ? `<img src="${u.avatar_url}" style="width:100%;height:100%;object-fit:cover;">` : `<i class="fa fa-user"></i>`}</div>
            <div class="txt"><b>@${u?.username||'User'}</b> ${item.type==='like'?'liked your post':'subscribed to you'}
                <div class="time">${new Date(item.created_at).toLocaleDateString()}</div>
            </div>
            <div class="icon-box"><i class="fa ${item.type==='like'?'fa-heart':'fa-user-plus'}"></i></div>
        </div>`;
    }
    cont.innerHTML = h;
}
window.clearAll = async () => { if(confirm("Clear all?")) { await supabase.from('notifications').delete().eq('user_id', myId); load(); } };
load();
</script>
</body>
</html>