<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Activity</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
body {
  margin:0;
  font-family:-apple-system, BlinkMacSystemFont, sans-serif;
  background:#fff;
}

.nav {
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:15px 20px;
  border-bottom:1px solid #eee;
  position:sticky;
  top:0;
  background:#fff;
}

.nav-left {
  display:flex;
  align-items:center;
  gap:15px;
}

.clear {
  font-size:13px;
  color:#1877f2;
  cursor:pointer;
}

.item {
  display:flex;
  align-items:center;
  gap:12px;
  padding:16px 20px;
  border-bottom:1px solid #f5f5f5;
  text-decoration:none;
  color:#000;
}

.av {
  width:44px;
  height:44px;
  border-radius:50%;
  background:#eee;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
}

.av img {
  width:100%;
  height:100%;
  object-fit:cover;
}

.txt {
  font-size:14px;
  line-height:1.4;
}

.time {
  font-size:11px;
  color:#999;
  margin-top:3px;
}
</style>
</head>

<body>

<div class="nav">
  <div class="nav-left">
    <i class="fa fa-arrow-left" onclick="history.back()"></i>
    <b>Activity</b>
  </div>
  <div class="clear" onclick="clearAll()">Clear all</div>
</div>

<div id="list"></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://spnvgymmrlyqtfrbjjsg.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwbnZneW1tcmx5cXRmcmJqanNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzM4ODMsImV4cCI6MjA4MzUwOTg4M30.EAgw94HZsHa21YLcTuV0GLAlUeRZN-ixKA0QeD5oPNI"
);

const myId = localStorage.getItem("user_id");

async function loadNotifications() {
  if (!myId) return;

  // Mark all as read immediately
  await supabase
    .from("notifications")
    .update({ is_read: true })
    .eq("user_id", myId);

  const { data } = await supabase
    .from("notifications")
    .select("*")
    .eq("user_id", myId)
    .order("created_at", { ascending:false });

  const list = document.getElementById("list");
  list.innerHTML = "";

  if (!data || !data.length) {
    list.innerHTML = `<p style="text-align:center;color:#999;margin-top:60px;">No activity yet.</p>`;
    return;
  }

  for (const n of data) {
    let name = "Anonymous";
    let avatar = `<i class="fa fa-user" style="color:#aaa"></i>`;

    if (n.sender_id && n.sender_id !== "anon") {
      const { data: u } = await supabase
        .from("profiles")
        .select("username, avatar_url")
        .eq("id", n.sender_id)
        .single();

      if (u) {
        name = `@${u.username}`;
        if (u.avatar_url) avatar = `<img src="${u.avatar_url}">`;
      }
    }

    let text = "";
    if (n.type === "like") text = "liked your post";
    if (n.type === "follow") text = "started following you";

    list.innerHTML += `
      <a class="item" href="${n.post_id ? `post.html?id=${n.post_id}` : "#"}">
        <div class="av">${avatar}</div>
        <div class="txt">
          <b>${name}</b> ${text}
          <div class="time">${new Date(n.created_at).toLocaleString()}</div>
        </div>
      </a>
    `;
  }
}

async function clearAll() {
  if (!myId) return;
  await supabase.from("notifications").delete().eq("user_id", myId);
  document.getElementById("list").innerHTML =
    `<p style="text-align:center;color:#999;margin-top:60px;">No activity yet.</p>`;
}

loadNotifications();
</script>

</body>
</html> 
