<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Profile â€¢ Globaltrends</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
<style>
    body { margin:0; font-family:-apple-system, sans-serif; background:#fff; -webkit-user-select: none; user-select: none; overflow-x: hidden; }
    
    /* NAV */
    .nav { display:flex; justify-content:space-between; align-items:center; padding:12px 18px; border-bottom:1px solid #eee; position:sticky; top:0; background:#fff; z-index: 1000; }
    .nav-right { display: flex; align-items: center; gap: 18px; }
    .notif-badge { position: absolute; top: -5px; right: -5px; background: #ff2d55; color: #fff; font-size: 10px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #fff; font-weight: bold; }

    /* DROPDOWN */
    .dropdown-menu { position: absolute; top: 45px; right: 0; background: #fff; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); display: none; flex-direction: column; z-index: 2000; min-width: 200px; border: 1px solid #eee; overflow: hidden; }
    .dropdown-item { padding: 14px 18px; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #f5f5f5; cursor: pointer; color: #333; }

    /* PROFILE HEADER */
    .profile-hdr { text-align:center; padding:20px; }
    .p-avatar-container { width: 95px; height: 95px; border-radius: 50%; margin: 0 auto; overflow: hidden; border: 3px solid #f8f8f8; background: #fff; position: relative; }
    .p-avatar-img { width: 100%; height: 100%; object-fit: cover; }
    
    /* GRID - FIXED BLACK BOXES */
    .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background:#f0f0f0; }
    .grid-item { aspect-ratio: 9/16; background:#111; position: relative; overflow: hidden; cursor: pointer; }
    .grid-item img, .grid-item video { width: 100%; height: 100%; object-fit: cover; background: #000; }
    .media-badge { position: absolute; top: 8px; right: 8px; color: #fff; background: rgba(0,0,0,0.5); padding: 4px; border-radius: 4px; font-size: 11px; z-index: 10; }

    /* FULL SCREEN PLAYER */
    #fsPlayer { position: fixed; inset: 0; background: #000; z-index: 9000; display: none; flex-direction: column; }
    .fs-close { position: absolute; top: 20px; left: 20px; color: #fff; font-size: 26px; z-index: 9500; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .carousel-item { min-width: 100vw; height: 100vh; scroll-snap-align: center; display: flex; align-items: center; justify-content: center; background: #000; }
    .carousel-item img, .carousel-item video { max-width: 100%; max-height: 100%; object-fit: contain; }

    .fs-info { position: absolute; bottom: 0; left: 0; width: 100%; padding: 80px 20px 40px; background: linear-gradient(transparent, rgba(0,0,0,0.9)); color: #fff; z-index: 9100; pointer-events: none; box-sizing: border-box; }
    .fs-actions { position: absolute; right: 20px; bottom: 150px; color: #fff; text-align: center; z-index: 9200; }
    
    /* LION BUTTON */
    .lion-btn { font-size: 45px; color: #FFD700; cursor: pointer; filter: drop-shadow(0 0 5px rgba(0,0,0,0.3)); transition: 0.2s; }
    .lion-btn.active { transform: scale(1.2); color: #FFA500; filter: drop-shadow(0 0 15px #FFD700); }

    /* TOAST */
    .confirm-toast { position: fixed; bottom: -100%; left: 0; width: 100%; background: #fff; border-radius: 25px 25px 0 0; z-index: 10000; padding: 30px; transition: 0.3s; text-align: center; box-sizing: border-box; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
    .confirm-toast.active { bottom: 0; }
    .btn-main { padding: 12px 25px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
</style>
</head>
<body>

<div id="confirmToast" class="confirm-toast">
    <div id="toastMsg" style="margin-bottom:20px; font-weight:bold;"></div>
    <div style="display:flex; gap:10px;">
        <button onclick="closeToast()" class="btn-main" style="flex:1; background:#eee;">No</button>
        <button id="toastYes" class="btn-main" style="flex:1; background:#ff2d55; color:#fff;">Yes</button>
    </div>
</div>

<div id="fsPlayer">
    <i class="fa fa-times fs-close" onclick="closeFS()"></i>
    <div id="mediaContent" style="display:flex; overflow-x:auto; scroll-snap-type:x mandatory; height:100%; scrollbar-width:none;"></div>
    <div class="fs-info">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <img id="fsAv" style="width:40px; height:40px; border-radius:50%; object-fit:cover; border:2px solid #fff;">
            <b id="fsUn"></b><span id="fsVer"></span>
        </div>
        <div id="fsCap"></div>
    </div>
    <div class="fs-actions" id="fsActions"></div>
</div>

<div class="nav">
    <i class="fa fa-arrow-left" onclick="history.back()"></i>
    <b>Profile</b>
    <div class="nav-right">
        <i class="fa fa-share-alt" onclick="navigator.share({url:window.location.href})"></i>
        <div id="notifArea" style="position:relative; display:none;" onclick="location.href='notifications.html'">
            <i class="fa fa-bell"></i><span id="nDot" class="notif-badge">0</span>
        </div>
        <div style="position:relative;">
            <i class="fa fa-ellipsis-v" onclick="toggleDrop(event)"></i>
            <div id="drop" class="dropdown-menu">
                <div class="dropdown-item" onclick="location.href='dashboard.html'"><i class="fa fa-chart-line"></i> View Dashboard</div>
                <div class="dropdown-item" onclick="askOut()" style="color:#ff2d55;"><i class="fa fa-sign-out-alt"></i> Logout</div>
            </div>
        </div>
    </div>
</div>

<div class="profile-hdr">
    <div class="p-avatar-container"><img id="pAv" class="p-avatar-img"></div>
    <div style="display:flex; justify-content:center; align-items:center; gap:5px; margin-top:12px;">
        <b id="pUn" style="font-size:20px;"></b><span id="pVer"></span>
    </div>
    <div id="pBio" style="font-size:14px; color:#666; margin-top:8px;"></div>
    
    <div style="width:85%; margin:20px auto; border:1px solid #eee; padding:12px; border-radius:12px;">
        <div style="display:flex; justify-content:space-between; font-size:10px; font-weight:900; color:#aaa; margin-bottom:5px;">
            <span>10K SUBS GOAL</span><span id="gPct">0%</span>
        </div>
        <div style="width:100%; height:8px; background:#f0f0f0; border-radius:10px; overflow:hidden;">
            <div id="bar" style="height:100%; width:0%; background:#ff2d55; transition:1s;"></div>
        </div>
    </div>

    <div style="display:flex; justify-content:center; gap:40px;">
        <div style="text-align:center;"><b id="sCount" style="font-size:18px; display:block;">0</b><small style="color:#888;">Subscribers</small></div>
        <div style="text-align:center;"><b id="lCount" style="font-size:18px; display:block;">0</b><small style="color:#888;">Total Likes</small></div>
    </div>
    <div id="btnRow" style="margin-top:20px;"></div>
</div>

<div id="grid" class="grid"></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient("https://spnvgymmrlyqtfrbjjsg.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwbnZneW1tcmx5cXRmcmJqanNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzM4ODMsImV4cCI6MjA4MzUwOTg4M30.EAgw94HZsHa21YLcTuV0GLAlUeRZN-ixKA0QeD5oPNI");

let myId = localStorage.getItem("user_id"), profileId = new URLSearchParams(location.search).get("id") || myId, pData = null, isSub = false;

window.toggleDrop = (e) => { e.stopPropagation(); const d = document.getElementById('drop'); d.style.display = d.style.display === 'flex' ? 'none' : 'flex'; };
document.onclick = () => document.getElementById('drop').style.display = 'none';

window.closeToast = () => document.getElementById('confirmToast').classList.remove('active');
window.askOut = () => { document.getElementById('toastMsg').innerText = "Logout?"; document.getElementById('confirmToast').classList.add('active'); document.getElementById('toastYes').onclick = () => { localStorage.clear(); location.href='login.html' }; };

async function load() {
    const [p, s, v, f] = await Promise.all([
        supabase.from("profiles").select("*").eq("id", profileId).single(),
        supabase.from("follows").select("*", {count:"exact", head:true}).eq("user_id", profileId),
        supabase.from("posts").select("*").eq("user_id", profileId).order('created_at', {ascending: false}),
        myId ? supabase.from("follows").select("*").eq("user_id", profileId).eq("follower_id", myId).single() : {data:null}
    ]);
    if(!p.data) return; pData = p.data; isSub = !!f.data;
    
    document.getElementById('pAv').src = pData.avatar_url;
    document.getElementById('pUn').innerText = `@${pData.username}`;
    document.getElementById('pBio').innerText = pData.bio || "";
    if(pData.verified) document.getElementById('pVer').innerHTML = '<i class="fa fa-check-circle" style="color:#1DA1F2; font-size:14px;"></i>';
    
    const sc = s.count || 0;
    document.getElementById('sCount').innerText = sc;
    document.getElementById('lCount').innerText = v.data?.reduce((a, b) => a + (b.likes || 0), 0) || 0;
    
    let pct = (sc / 10000) * 100;
    document.getElementById('bar').style.width = Math.min(pct, 100) + "%";
    document.getElementById('gPct').innerText = Math.floor(pct) + "%";

    // GRID WITH VIDEO THUMBNAIL FIX
    document.getElementById('grid').innerHTML = v.data?.map(i => {
        const isVid = i.media_type === 'video';
        return `<div class="grid-item" onclick='openFS(${JSON.stringify(i)})'>
            <div class="media-badge"><i class="fa ${isVid?'fa-video':(i.media_urls.length>1?'fa-clone':'fa-image')}"></i></div>
            ${isVid ? `<video src="${i.video_url}#t=0.1" preload="metadata"></video>` : `<img src="${i.media_urls[0]}">`}
        </div>`;
    }).join("");

    const br = document.getElementById('btnRow');
    if(myId === profileId) {
        br.innerHTML = `<button onclick="location.href='edit-profile.html'" style="width:160px; padding:10px; border-radius:8px; border:none; background:#f2f2f2; font-weight:bold;">Edit Profile</button>`;
        const n = await supabase.from('notifications').select('*',{count:'exact', head:true}).eq('user_id', myId).eq('is_read', false);
        if(n.count > 0) { document.getElementById('notifArea').style.display='block'; document.getElementById('nDot').innerText=n.count; }
    } else {
        br.innerHTML = `<button id="sBtn" onclick="toggleSub()" style="width:160px; padding:10px; border-radius:8px; border:none; background:${isSub?'#f2f2f2':'#000'}; color:${isSub?'#555':'#fff'}; font-weight:bold;">${isSub?'ðŸ’Ÿ Subscribed':'Subscribe'}</button>`;
    }
}

window.toggleSub = async () => {
    if(!myId) return location.href='login.html';
    const b = document.getElementById('sBtn'), c = document.getElementById('sCount');
    let n = parseInt(c.innerText);
    if(isSub) {
        isSub = false; n--; b.innerText='Subscribe'; b.style.background='#000'; b.style.color='#fff';
        await supabase.from("follows").delete().eq("user_id", profileId).eq("follower_id", myId);
    } else {
        isSub = true; n++; b.innerText='ðŸ’Ÿ Subscribed'; b.style.background='#f2f2f2'; b.style.color='#555';
        await supabase.from("follows").insert([{user_id:profileId, follower_id:myId}]);
    }
    c.innerText = n;
};

window.openFS = (post) => {
    const c = document.getElementById('mediaContent'), a = document.getElementById('fsActions');
    document.getElementById('fsPlayer').style.display = 'flex';
    document.getElementById('fsAv').src = pData.avatar_url;
    document.getElementById('fsUn').innerText = `@${pData.username}`;
    document.getElementById('fsCap').innerText = post.caption || "";
    document.getElementById('fsVer').innerHTML = pData.verified ? '<i class="fa fa-check-circle" style="color:#1DA1F2"></i>' : '';

    if(post.media_type === 'photo') {
        c.innerHTML = post.media_urls.slice(0,10).map(u => `<div class="carousel-item"><img src="${u}"></div>`).join("");
        const active = localStorage.getItem(`lion_${post.id}`) ? 'active' : '';
        a.innerHTML = `<i id="lBtn" class="fa fa-paw lion-btn ${active}" onclick="toggleLion(${post.id})"></i><div style="font-weight:bold; font-size:12px; margin-top:5px;">${post.lions || 0} LIONS</div>`;
    } else {
        c.innerHTML = `<div class="carousel-item"><video src="${post.video_url}" autoplay loop playsinline></video></div>`;
        a.innerHTML = `<i class="fa fa-heart" style="color:#ff2d55; font-size:35px;"></i><div style="font-weight:bold; font-size:12px; margin-top:5px;">${post.likes || 0} LIKES</div>`;
    }
};

window.toggleLion = async (id) => {
    const b = document.getElementById('lBtn'), t = b.nextSibling;
    let n = parseInt(t.innerText);
    if(b.classList.contains('active')) {
        b.classList.remove('active'); n--; localStorage.removeItem(`lion_${id}`);
    } else {
        b.classList.add('active'); n++; localStorage.setItem(`lion_${id}`, 'true');
    }
    t.innerText = `${n} LIONS`;
    await supabase.from("posts").update({ lions: n }).eq('id', id);
};

window.closeFS = () => { document.getElementById('fsPlayer').style.display='none'; document.getElementById('mediaContent').innerHTML=""; };
load();
</script>
</body>
                </html>
