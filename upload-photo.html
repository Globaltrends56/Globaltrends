<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Post photo â€¢ Globaltrends</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
<style>
:root { --primary:#ff2d55; --bg:#fff; --border:#efefef; }
body { margin:0; font-family:-apple-system,sans-serif; background:var(--bg); }
.header { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border); position:sticky; top:0; background:#fff; z-index:100; }
.header b { font-size:17px; }
.post-btn-text { color:var(--primary); font-weight:700; cursor:pointer; }
.container { padding:20px; }
.upload-box { border:2px dashed #ddd; border-radius:12px; padding:40px 20px; text-align:center; background:#fafafa; cursor:pointer; display:block; }
.preview-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:20px; }
.preview-grid img { width:100%; aspect-ratio:1; object-fit:cover; border-radius:8px; border:1px solid #eee; }
.caption { width:100%; border:1px solid var(--border); border-radius:12px; padding:15px; margin-top:20px; font-size:15px; outline:none; resize:none; background:#fafafa; box-sizing:border-box; }
.post-btn { width:100%; margin-top:25px; padding:16px; border:none; border-radius:12px; background:var(--primary); color:#fff; font-weight:700; font-size:16px; }
.toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#111; color:#fff; padding:12px 24px; border-radius:30px; display:none; z-index:10000; text-align:center; width:80%; }
</style>
</head>
<body>

<div id="toast" class="toast"></div>

<div class="header">
  <span onclick="history.back()">Cancel</span>
  <b>New Photo Post</b>
  <span class="post-btn-text" onclick="upload()">Post</span>
</div>

<div class="container">
  <label class="upload-box" id="uploadLabel">
    <input type="file" id="photos" accept="image/*" hidden>
    <i class="fa fa-images" style="font-size:30px; color:var(--primary); margin-bottom:10px;"></i>
    <div style="font-weight:600">Select Photos</div>
  </label>

  <div class="preview-grid" id="previewGrid"></div>
  <textarea id="caption" class="caption" rows="4" placeholder="Write a caption..."></textarea>
  <button id="mainBtn" class="post-btn" onclick="upload()">Share Post</button>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://spnvgymmrlyqtfrbjjsg.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwbnZneW1tcmx5cXRmcmJqanNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzM4ODMsImV4cCI6MjA4MzUwOTg4M30.EAgw94HZsHa21YLcTuV0GLAlUeRZN-ixKA0QeD5oPNI"
);

const myId = localStorage.getItem("user_id");

// --- CODY CONFIG ---
const WIDGET_ID = "W4QbY5Mppbzq"; 

const input = document.getElementById("photos");
const grid = document.getElementById("previewGrid");
const files = [];

function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg; t.style.display="block";
  setTimeout(()=>t.style.display="none",3000);
}

input.onchange = e => {
  const f = e.target.files[0];
  if(!f) return;
  files.push(f);
  const img = document.createElement("img");
  img.src = URL.createObjectURL(f);
  grid.appendChild(img);
};

window.upload = async () => {
  if (!files.length) return showToast("Select photo");
  if (!myId) return showToast("User ID not found");

  const caption = document.getElementById("caption").value;
  const btn = document.getElementById("mainBtn");
  btn.disabled = true;
  btn.textContent = "AI Security Check...";

  try {
    // 1. DIRECT WIDGET MESSAGE (Bypasses Connection Errors)
    const res = await fetch(`https://getcody.ai/api/v1/widgets/${WIDGET_ID}/message`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        content: `MODERATION: Check this caption: "${caption}". If it contains nudity, porn, or gore, reply ONLY 'BLOCK'. Else 'PASS'.`
      })
    });

    const data = await res.json();
    const verdict = (data.data?.content || "").toUpperCase();

    if (verdict.includes("BLOCK")) {
      showToast("Violation! Suspending account...");
      await supabase.from("profiles").update({ status: "suspended" }).eq("id", myId);
      setTimeout(() => location.href = "suspended.html", 2000);
      return;
    }

    // 2. UPLOAD TO SUPABASE
    btn.textContent = "Uploading...";
    const urls = [];
    for (const file of files) {
      const path = `${myId}/${Date.now()}.jpg`;
      await supabase.storage.from("photos").upload(path, file);
      urls.push(supabase.storage.from("photos").getPublicUrl(path).data.publicUrl);
    }

    await supabase.from("posts").insert({
      user_id: myId,
      media_type: "photo",
      media_urls: urls,
      caption: caption,
      likes: 0
    });

    location.href = "profile.html";

  } catch (e) {
    console.error(e);
    showToast("System Error. Posting...");
    // Fail-safe: Post anyway if AI crashes
    location.href = "profile.html";
  }
};
</script>
</body>
</html>
