<style>
/* SHOW ONLY ON HOMEPAGE */
body:not(.homepage) #tiktok-feed { display: none; }

/* FEED CONTAINER */
#tiktok-feed {
  position: fixed; inset: 0; background: #000;
  overflow-y: scroll; scroll-snap-type: y mandatory; z-index: 1;
}

.tiktok-post { height: 100vh; scroll-snap-align: start; position: relative; display: flex; flex-direction: column; }

/* VIDEO WRAPPER & SHIELD */
.video-wrapper {
  position: relative;
  width: 100%;
  height: 85%;
  background: #000;
  overflow: hidden;
}

.tiktok-post video { 
    width: 100%; height: 100%; object-fit: cover; 
    pointer-events: none; /* Video doesn't catch touches, shield does */
}

.video-shield {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 10;
    background: transparent;
    -webkit-touch-callout: none !important; /* Disables iOS system menu */
    user-select: none !important;
}

/* Hide download buttons in Chrome/Android Enclosure */
video::-internal-media-controls-download-button { display:none; }
video::-webkit-media-controls-enclosure { overflow:hidden; }
video::-webkit-media-controls-panel { width: calc(100% + 30px); }

.ad-container-bottom { height: 15%; width: 100%; background: #000; display: flex; align-items: center; justify-content: center; }

/* OVERLAY & USER INFO */
.overlay { position: absolute; bottom: 110px; left: 12px; right: 80px; color: #fff; z-index: 20; pointer-events: none; }
.user-row { display: flex; align-items: center; gap: 10px; pointer-events: auto; }
.avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; }

.username-container { display: flex; align-items: center; gap: 8px; }
.username-link { display: flex; align-items: center; color: #fff !important; text-decoration: none; font-weight: bold; white-space: nowrap; }
.verify { color: #1DA1F2; margin-left: 4px; font-size: 14px; }

/* SYNCED FOLLOW BUTTON */
.feed-follow-btn {
  background: #1DA1F2; color: #fff; border: none; padding: 4px 10px;
  border-radius: 4px; font-size: 11px; font-weight: bold; cursor: pointer; transition: 0.2s; flex-shrink: 0;
}
.feed-follow-btn.followed { background: rgba(255,255,255,0.2); color: #ccc; }

/* TOAST NOTIFICATION */
.toast {
  position: fixed; top: -50px; left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,0.8); color: #fff; padding: 8px 20px;
  border-radius: 20px; font-size: 13px; transition: 0.4s; z-index: 9999;
}
.toast.show { top: 20px; }

.caption { font-size: 14px; line-height: 1.4; margin-top: 8px; }
.actions { position: absolute; right: 14px; bottom: 130px; color: #fff; display: flex; flex-direction: column; gap: 18px; text-align: center; z-index: 20; }
.heart { font-size: 28px; cursor: pointer; transition: transform 0.2s; }
.heart.liked { color: #ff2d55; animation: pop .3s; }
.view-icon { font-size: 24px; margin-bottom: 2px; }

@keyframes pop { 50% { transform: scale(1.6); } }
</style>

<div id="toast" class="toast"></div>
<div id="tiktok-feed"></div>

<script>
if (location.pathname === "/" || location.pathname === "/index.html") { document.body.classList.add("homepage"); }

const SUPABASE_URL = "https://spnvgymmrlyqtfrbjjsg.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwbnZneW1tcmx5cXRmcmJqanNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzM4ODMsImV4cCI6MjA4MzUwOTg4M30.EAgw94HZsHa21YLcTuV0GLAlUeRZN-ixKA0QeD5oPNI";

const myId = localStorage.getItem("user_id");
let currentVideo = null;
let videoCounter = 0;

function nFormatter(num) {
    if (!num) return 0;
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
    return num;
}

function showToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg; t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2000);
}

document.addEventListener("DOMContentLoaded", async () => {
  const feed = document.getElementById("tiktok-feed");
  const interests = JSON.parse(localStorage.getItem("my_interests")) || [];

  const res = await fetch(`${SUPABASE_URL}/rest/v1/posts?select=id,user_id,video_url,caption,likes,views,profiles(username,avatar_url,verified)`, { headers: { apikey: SUPABASE_KEY } });
  let posts = await res.json();

  posts.sort((a, b) => {
    const aF = interests.includes(a.user_id) ? 1 : 0;
    const bF = interests.includes(b.user_id) ? 1 : 0;
    return bF - aF || Math.random() - 0.5;
  });

  posts.forEach(post => {
    if (!post.video_url) return;
    videoCounter++; 
    const liked = localStorage.getItem("liked_" + post.id);
    const isFollowed = interests.includes(post.user_id);
    const div = document.createElement("div");
    div.className = "tiktok-post";

    let adHtml = (videoCounter === 3) ? `<div class="ad-container-bottom" id="ad-slot-3"></div>` : `<div class="ad-container-bottom"></div>`;

    div.innerHTML = `
      <div class="video-wrapper">
        <video src="${post.video_url}" muted loop playsinline controlsList="nodownload" oncontextmenu="return false;"></video>
        <div class="video-shield"></div>
      </div>
      ${adHtml}
      <div class="overlay">
        <div class="user-row">
          <img class="avatar" src="${post.profiles?.avatar_url || 'https://via.placeholder.com/100'}">
          <div class="username-container">
             <a class="username-link" href="https://globaltrends.vercel.app/profile.html?id=${post.user_id}">
                @${post.profiles?.username || "user"}
                ${post.profiles?.verified ? '<i class="fa fa-check-circle verify"></i>' : ''}
             </a>
             <button class="feed-follow-btn ${isFollowed ? 'followed' : ''}" data-uid="${post.user_id}">
                ${isFollowed ? 'Following' : 'Follow'}
             </button>
          </div>
        </div>
        <div class="caption">${post.caption || ""}</div>
      </div>
      <div class="actions">
        <div class="like-btn" data-id="${post.id}">
            <div class="heart ${liked ? 'liked' : ''}">‚ù§</div>
            <div class="count">${nFormatter(post.likes)}</div>
        </div>
        <div>
            <div class="view-icon">üëÅÔ∏è‚Äçüó®Ô∏è</div>
            <div id="view-${post.id}">${nFormatter(post.views)}</div>
        </div>
      </div>`;

    const video = div.querySelector("video");
    const shield = div.querySelector(".video-shield");
    const likeBtn = div.querySelector(".like-btn");
    const followBtn = div.querySelector(".feed-follow-btn");

    let lastTap = 0;
    shield.addEventListener("click", () => {
      const now = Date.now();
      if (now - lastTap < 300) {
        likePost(post.id, likeBtn, post.likes); 
      } else {
        video.muted = !video.muted;
        video.volume = 1;
        showToast(video.muted ? "Muted" : "üîä Sound On");
      }
      lastTap = now;
    });

    likeBtn.addEventListener("click", e => {
      e.stopPropagation();
      likePost(post.id, likeBtn, post.likes);
    });

    followBtn.addEventListener("click", async e => {
      e.stopPropagation();
      if(!myId) { showToast("Login to follow"); return; }
      const uid = followBtn.dataset.uid;
      let cur = JSON.parse(localStorage.getItem("my_interests")) || [];

      if (!cur.includes(uid)) {
        followBtn.textContent = "Following";
        followBtn.classList.add("followed");
        cur.push(uid);
        showToast("Following creator");
        await fetch(`${SUPABASE_URL}/rest/v1/followers`, {
          method: "POST",
          headers: { apikey: SUPABASE_KEY, "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: uid, follower_id: myId })
        });
      } else {
        followBtn.textContent = "Follow";
        followBtn.classList.remove("followed");
        cur = cur.filter(i => i !== uid);
        showToast("Unfollowed");
        await fetch(`${SUPABASE_URL}/rest/v1/followers?user_id=eq.${uid}&follower_id=eq.${myId}`, {
          method: "DELETE",
          headers: { apikey: SUPABASE_KEY }
        });
      }
      localStorage.setItem("my_interests", JSON.stringify(cur));
    });

    const observer = new IntersectionObserver(entries => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          if (currentVideo && currentVideo !== video) {
            currentVideo.pause();
            currentVideo.muted = true;
          }
          currentVideo = video;
          video.play().catch(()=>{});
          incrementView(post.id, post.views);
        } else {
          video.pause();
          video.muted = true;
        }
      });
    }, { threshold: 0.6 });

    observer.observe(div);
    feed.appendChild(div);
  });
});

async function likePost(id, el, initialLikes) {
  if (!myId) {
      showToast("Login to like video");
      return;
  }
  const heart = el.querySelector(".heart");
  const countLabel = el.querySelector(".count");
  let rawLikes = parseInt(localStorage.getItem("raw_likes_" + id)) || initialLikes || 0;

  if (localStorage.getItem("liked_" + id)) {
    rawLikes--; localStorage.removeItem("liked_" + id); heart.classList.remove("liked");
  } else {
    rawLikes++; localStorage.setItem("liked_" + id, "1"); heart.classList.add("liked");
  }

  localStorage.setItem("raw_likes_" + id, rawLikes);
  countLabel.textContent = nFormatter(rawLikes);

  await fetch(`${SUPABASE_URL}/rest/v1/posts?id=eq.${id}`, {
    method: "PATCH",
    headers: { apikey: SUPABASE_KEY, "Content-Type": "application/json" },
    body: JSON.stringify({ likes: rawLikes })
  });
}

async function incrementView(id, initialViews) {
  if (localStorage.getItem("viewed_" + id)) return;
  localStorage.setItem("viewed_" + id, "1");

  const rawViews = (initialViews || 0) + 1;
  const el = document.getElementById("view-" + id);
  if (el) el.textContent = nFormatter(rawViews);

  await fetch(`${SUPABASE_URL}/rest/v1/posts?id=eq.${id}`, {
    method: "PATCH",
    headers: { apikey: SUPABASE_KEY, "Content-Type": "application/json" },
    body: JSON.stringify({ views: rawViews })
  });
}
</script>
