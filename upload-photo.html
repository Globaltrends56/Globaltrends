<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Upload Photo â€¢ Globaltrends</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
    <style>
        body { margin:0; font-family:-apple-system, sans-serif; background:#fff; -webkit-touch-callout:none; }
        .nav { display:flex; align-items:center; padding:12px 18px; border-bottom:1px solid #eee; gap:20px; }
        .upload-container { padding: 20px; text-align: center; }
        .preview-box { width: 100%; aspect-ratio: 1/1; background: #f0f0f0; border-radius: 12px; margin-bottom: 20px; overflow: hidden; display: none; }
        img { width: 100%; height: 100%; object-fit: cover; -webkit-touch-callout: none; }
        textarea { width: 100%; border: 1px solid #eee; border-radius: 8px; padding: 12px; box-sizing: border-box; font-family: inherit; margin-bottom: 20px; resize: none; }
        .btn-post { width: 100%; padding: 15px; background: #000; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="loadingOverlay">
    <i class="fa fa-spinner fa-spin" style="font-size: 30px; margin-bottom: 10px;"></i>
    <b id="statusText">AI Security Scanning...</b>
</div>

<div class="nav">
    <i class="fa fa-times" onclick="history.back()"></i>
    <b>New Photo Post</b>
</div>

<div class="upload-container">
    <div id="previewBox" class="preview-box">
        <img id="previewImg" oncontextmenu="return false;">
    </div>
    
    <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handleFile(this)">
    <button onclick="document.getElementById('photoInput').click()" id="selectBtn" style="margin-bottom: 20px; padding: 10px 20px; border-radius: 20px; border: 1px solid #000; background: none; font-weight: bold;">Select Photo</button>

    <textarea id="caption" placeholder="Write a caption..." rows="4"></textarea>
    <button id="uploadBtn" class="btn-post" onclick="startUpload()" disabled>Post Photo</button>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient("https://spnvgymmrlyqtfrbjjsg.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwbnZneW1tcmx5cXRmcmJqanNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzM4ODMsImV4cCI6MjA4MzUwOTg4M30.EAgw94HZsHa21YLcTuV0GLAlUeRZN-ixKA0QeD5oPNI");

const GEMINI_KEY = "AIzaSyDdlC8_lta2_8hE3O8Q1VvNSmjBDfycbdY";
let selectedFile = null;
const myId = localStorage.getItem("user_id");

window.handleFile = (input) => {
    selectedFile = input.files[0];
    if (selectedFile) {
        document.getElementById('previewImg').src = URL.createObjectURL(selectedFile);
        document.getElementById('previewBox').style.display = 'block';
        document.getElementById('uploadBtn').disabled = false;
    }
};

async function checkAISecurity(file) {
    const base64 = await new Promise(r => {
        const reader = new FileReader();
        reader.onload = () => r(reader.result.split(',')[1]);
        reader.readAsDataURL(file);
    });

    const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            contents: [{ parts: [
                { text: "Check this image for nudity, NSFW, or violence. Answer only 'SAFE' or 'BANNED'." },
                { inline_data: { mime_type: file.type, data: base64 } }
            ]}]
        })
    });
    const data = await resp.json();
    return data.candidates[0].content.parts[0].text.trim().toUpperCase();
}

window.startUpload = async () => {
    if (!selectedFile || !myId) return;
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = 'flex';

    try {
        const verdict = await checkAISecurity(selectedFile);
        
        if (verdict === "BANNED") {
            document.getElementById('statusText').innerText = "Content Banned. Suspending...";
            await supabase.from('profiles').update({ status: 'suspended' }).eq('id', myId);
            setTimeout(() => location.href = 'suspended.html', 2000);
            return;
        }

        const fileName = `${Date.now()}_photo.jpg`;
        await supabase.storage.from('photos').upload(fileName, selectedFile);
        const { data: urlData } = supabase.storage.from('photos').getPublicUrl(fileName);

        await supabase.from('posts').insert([{
            user_id: myId,
            media_urls: [urlData.publicUrl],
            caption: document.getElementById('caption').value,
            media_type: 'photo'
        }]);

        location.href = 'profile.html';
    } catch (e) {
        alert("Error");
        overlay.style.display = 'none';
    }
};
</script>
</body>
    </html>
