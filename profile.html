<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont;background:#fff}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid #eee}
.top-icons i{margin-left:14px;font-size:18px;cursor:pointer}

.profile{padding:16px}
.row{display:flex;align-items:center}
.avatar{width:80px;height:80px;border-radius:50%;background:#eee;overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover}
.info{margin-left:16px}
.username{font-weight:600;font-size:18px}
.bio{color:#555;margin-top:6px}

.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:2px;margin-top:10px}
.grid-item{position:relative;background:#000;cursor:pointer}
.grid-item img,.grid-item video{width:100%;height:100%;object-fit:cover}
.media-indicator{position:absolute;top:6px;right:6px;font-size:14px;color:#fff}

#fsPlayer{position:fixed;inset:0;background:#000;display:none;z-index:999}
#fsTop{position:absolute;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;align-items:center;color:#fff}
#fsMedia{width:100%;height:100%;display:flex;align-items:center;justify-content:center}
#fsMedia img,#fsMedia video{max-width:100%;max-height:100%}
#fsInfo{position:absolute;bottom:80px;left:14px;color:#fff}
#fsActions{position:absolute;bottom:20px;left:14px;color:#fff}

#delMenu{position:absolute;top:40px;right:10px;background:#222;color:#fff;border-radius:8px;display:none}
#delMenu div{padding:10px 14px;cursor:pointer}

#toast{position:fixed;bottom:40px;left:50%;transform:translateX(-50%);background:#222;color:#fff;padding:14px 18px;border-radius:10px;display:none}
.toast-btn{margin:6px;padding:6px 12px;border-radius:6px;border:none;cursor:pointer}
</style>
</head>

<body>

<div class="topbar">
  <i class="fa fa-arrow-left" onclick="history.back()"></i>
  <div class="top-icons">
    <i class="fa fa-share"></i>
    <i class="fa fa-bell"></i>
    <i class="fa fa-ellipsis-vertical"></i>
  </div>
</div>

<div class="profile">
  <div class="row">
    <div class="avatar"><img id="pAv"></div>
    <div class="info">
      <div class="username" id="pUn"></div>
      <div class="bio" id="pBio"></div>
    </div>
  </div>
</div>

<div class="grid" id="grid"></div>

<!-- FULLSCREEN -->
<div id="fsPlayer">
  <div id="fsTop">
    <div id="fsUser"></div>
    <div>
      <i class="fa fa-ellipsis-vertical" onclick="toggleDelMenu()"></i>
      <i class="fa fa-xmark" onclick="closeFS()" style="margin-left:14px"></i>
    </div>
  </div>

  <div id="fsMedia"></div>

  <div id="fsInfo">
    <div id="fsCaption"></div>
  </div>

  <div id="fsActions">
    <i class="fa fa-heart" onclick="toggleLike()"></i>
    <span id="likeCount">0</span>
  </div>

  <div id="delMenu">
    <div onclick="askDelete()">Delete post</div>
  </div>
</div>

<div id="toast"></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase=createClient(
 "https://spnvgymmrlyqtfrbjjsg.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwbnZneW1tcmx5cXRmcmJqanNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzM4ODMsImV4cCI6MjA4MzUwOTg4M30.EAgw94HZsHa21YLcTuV0GLAlUeRZN-ixKA0QeD5oPNI"
);

const uid=localStorage.getItem("user_id");
let posts=[],current,currentVideo;

const grid=document.getElementById("grid");
const fs=document.getElementById("fsPlayer");
const fsMedia=document.getElementById("fsMedia");
const toast=document.getElementById("toast");

function showToast(html){
 toast.innerHTML=html;
 toast.style.display="block";
}

function hideToast(){toast.style.display="none"}

function openFS(id){
 current=posts.find(p=>p.id===id);
 fs.style.display="block";
 fsMedia.innerHTML="";
 document.getElementById("likeCount").innerText=current.likes||0;

 if(current.type==="video"){
   const v=document.createElement("video");
   v.src=current.url;
   v.autoplay=true;
   v.loop=true;
   v.playsInline=true;
   currentVideo=v;
   fsMedia.appendChild(v);
 } else {
   const i=document.createElement("img");
   i.src=current.url;
   fsMedia.appendChild(i);
 }
}

function closeFS(){
 if(currentVideo){
   currentVideo.pause();
   currentVideo.removeAttribute("src");
   currentVideo.load();
   currentVideo=null;
 }
 fs.style.display="none";
 fsMedia.innerHTML="";
}

function toggleDelMenu(){
 delMenu.style.display=delMenu.style.display==="block"?"none":"block";
}

function askDelete(){
 showToast(`
  Delete this post?<br>
  <button class="toast-btn" onclick="hideToast()">Cancel</button>
  <button class="toast-btn" onclick="confirmDelete()">Delete</button>
 `);
}

async function confirmDelete(){
 await supabase.from("posts").delete().eq("id",current.id);
 location.reload();
}

function toggleLike(){
 current.likes=(current.likes||0)+1;
 document.getElementById("likeCount").innerText=current.likes;
}

async function load(){
 const {data:p}=await supabase.from("profiles").select("*").eq("id",uid).single();
 document.getElementById("pAv").src=p.avatar;
 document.getElementById("pUn").innerHTML="@"+p.username+(p.verified?" <i class='fa fa-check-circle' style='color:#1DA1F2'></i>":"");
 document.getElementById("pBio").innerText=p.bio||"";

 const {data}=await supabase.from("posts").select("*").eq("user_id",uid);
 posts=data||[];

 grid.innerHTML=posts.map(x=>`
  <div class="grid-item" onclick="openFS('${x.id}')">
   <div class="media-indicator">${x.type==="video"?"üéûÔ∏è":"üñºÔ∏è"}</div>
   ${x.type==="video"?`<video src="${x.url}#t=0.1" muted></video>`:`<img src="${x.url}">`}
  </div>`).join("");
}

load();
</script>
</body>
    </html>
