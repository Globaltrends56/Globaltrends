<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
    <style>
        body { margin:0; font-family:-apple-system, sans-serif; background: #fff; }
        .nav { display:flex; align-items:center; padding:15px 20px; border-bottom:1px solid #eee; position:sticky; top:0; background:#fff; gap:15px; }
        .item { display:flex; align-items:center; padding:16px 20px; gap:12px; border-bottom:1px solid #f9f9f9; text-decoration: none; color: inherit; }
        .av { width:44px; height:44px; border-radius:50%; background:#eee; overflow:hidden; display: flex; align-items: center; justify-content: center; }
        .av img { width: 100%; height: 100%; object-fit: cover; }
        .txt { font-size: 14px; line-height: 1.4; }
    </style>
</head>
<body>

<div class="nav">
    <i class="fa fa-arrow-left" onclick="history.back()"></i>
    <b>Activity</b>
</div>

<div id="list"></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient(
  "https://spnvgymmrlyqtfrbjjsg.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwbnZneW1tcmx5cXRmcmJqanNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzM4ODMsImV4cCI6MjA4MzUwOTg4M30.EAgw94HZsHa21YLcTuV0GLAlUeRZN-ixKA0QeD5oPNI"
);

const myId = localStorage.getItem("user_id");

async function load() {
    if (!myId) return;

    // 1️⃣ Mark all notifications as read (badge will disappear)
    await supabase
        .from('notifications')
        .update({ is_read: true })
        .eq('user_id', myId)
        .eq('is_read', false);

    // 2️⃣ Fetch notifications
    const { data: n } = await supabase
        .from('notifications')
        .select('*')
        .eq('user_id', myId)
        .order('created_at', { ascending: false });

    const cont = document.getElementById('list');

    if (!n?.length) {
        cont.innerHTML = '<p style="text-align:center;color:#999;margin-top:60px;">No activity yet.</p>';
        return;
    }

    for (const i of n) {
        let name = i.sender_name || "Anonymous";
        let avatar = '<i class="fa fa-user" style="color:#aaa"></i>';

        // 3️⃣ Only fetch profile if needed
        if (i.sender_id && i.sender_id !== "anon" && !i.sender_name) {
            const { data: u } = await supabase
                .from('profiles')
                .select('username, avatar_url')
                .eq('id', i.sender_id)
                .single();

            if (u) {
                name = `@${u.username}`;
                if (u.avatar_url) avatar = `<img src="${u.avatar_url}">`;
            }
        }

        let actionText = '';
        if (i.type === 'like') actionText = 'liked your post';
        if (i.type === 'subscribe') actionText = 'subscribed to you';

        cont.innerHTML += `
        <a href="profile.html?id=${i.sender_id || ''}" class="item">
            <div class="av">${avatar}</div>
            <div class="txt">
                <b>${name}</b> ${actionText}
                <div style="font-size:11px; color:#aaa; margin-top:3px;">
                    ${new Date(i.created_at).toLocaleDateString()}
                </div>
            </div>
        </a>`;
    }
}

load();
</script>
</body>
</html>
